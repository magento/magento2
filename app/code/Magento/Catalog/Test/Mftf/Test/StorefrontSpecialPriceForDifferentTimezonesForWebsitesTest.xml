<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="StorefrontSpecialPriceForDifferentTimezonesForWebsitesTest">
        <annotations>
            <features value="Catalog"/>
            <title value="Check that special price displayed when 'default config' scope timezone does not match 'website' scope timezone"/>
            <description value="Check that special price displayed when 'default config' scope timezone does not match 'website' scope timezone"/>
            <severity value="MAJOR"/>
            <testCaseId value="MAGETWO-97508"/>
            <useCaseId value="MAGETWO-96847"/>
            <group value="Catalog"/>
        </annotations>
        <before>
            <actionGroup ref="LoginAsAdmin" stepKey="login"/>

            <!--Create product-->
            <createData entity="SimpleProduct2" stepKey="createProduct"/>

            <!--Create customer-->
            <createData entity="Simple_US_Customer" stepKey="createCustomer"/>
        </before>
        <after>
            <!--Delete create data-->
            <deleteData createDataKey="createProduct" stepKey="deleteProduct"/>
            <deleteData createDataKey="createCustomer" stepKey="deleteCustomer"/>

            <actionGroup ref="logout" stepKey="logout"/>
        </after>

        <!--Set timezone for default config-->
        <amOnPage url="{{GeneralConfigurationPage.url}}" stepKey="goToGeneralConfig"/>
        <waitForPageLoad stepKey="waitForConfigPage"/>
        <conditionalClick selector="{{LocaleOptionsSection.sectionHeader}}" dependentSelector="{{LocaleOptionsSection.timezone}}" visible="false" stepKey="openLocaleSection"/>
        <grabValueFrom selector="{{LocaleOptionsSection.timezone}}" stepKey="originalTimezone"/>
        <selectOption selector="{{LocaleOptionsSection.timezone}}" userInput="Central European Standard Time (Europe/Paris)" stepKey="setTimezone"/>
        <click selector="{{AdminMainActionsSection.save}}" stepKey="saveConfig"/>

        <!--Set timezone for Main Website-->
        <amOnPage url="{{GeneralConfigurationPage.url}}" stepKey="goToGeneralConfig1"/>
        <waitForPageLoad stepKey="waitForConfigPage1"/>
        <actionGroup ref="AdminSwitchWebsiteActionGroup" stepKey="AdminSwitchStoreViewActionGroup">
            <argument name="website" value="_defaultWebsite"/>
        </actionGroup>
        <conditionalClick selector="{{LocaleOptionsSection.sectionHeader}}" dependentSelector="{{LocaleOptionsSection.timezone}}" visible="false" stepKey="openLocaleSection1"/>
        <uncheckOption selector="{{LocaleOptionsSection.useDefault}}"  stepKey="uncheckUseDefault"/>
        <grabValueFrom selector="{{LocaleOptionsSection.timezone}}" stepKey="originalTimezone1"/>
        <selectOption selector="{{LocaleOptionsSection.timezone}}" userInput="Greenwich Mean Time (Africa/Abidjan)" stepKey="setTimezone1"/>
        <click selector="{{AdminMainActionsSection.save}}" stepKey="saveConfig1"/>

        <!--Set special price to created product-->
        <amOnPage url="{{AdminProductEditPage.url($$createProduct.id$$)}}" stepKey="openAdminEditPage"/>
        <actionGroup ref="AddSpecialPriceToProductActionGroup" stepKey="setSpecialPriceToCreatedProduct">
            <argument name="price" value="15"/>
        </actionGroup>
        <actionGroup ref="saveProductForm" stepKey="saveProductForm"/>

        <!--Login to storefront from customer and check price-->
        <actionGroup ref="LoginToStorefrontActionGroup" stepKey="logInFromCustomer">
            <argument name="Customer" value="$$createCustomer$$"/>
        </actionGroup>

        <!--Go to the product page and check special price-->
        <amOnPage url="{{StorefrontProductPage.url($$createProduct.name$$)}}" stepKey="amOnSimpleProductPage"/>
        <waitForPageLoad stepKey="waitForPageLoad"/>
        <grabTextFrom selector="{{StorefrontProductInfoMainSection.specialPriceValue}}" stepKey="grabSpecialPrice"/>
        <assertEquals expected='$15.00' expectedType="string" actual="$grabSpecialPrice" stepKey="assertSpecialPrice"/>

        <!--Reset timezone-->
        <amOnPage url="{{GeneralConfigurationPage.url}}" stepKey="goToGeneralConfigReset"/>
        <waitForPageLoad stepKey="waitForConfigPageReset"/>
        <conditionalClick selector="{{LocaleOptionsSection.sectionHeader}}" dependentSelector="{{LocaleOptionsSection.timezone}}" visible="false" stepKey="openLocaleSectionReset"/>
        <selectOption selector="{{LocaleOptionsSection.timezone}}" userInput="$originalTimezone" stepKey="resetTimezone"/>
        <click selector="{{AdminMainActionsSection.save}}" stepKey="saveConfigReset"/>

        <!--Reset timezone-->
        <amOnPage url="{{GeneralConfigurationPage.url}}" stepKey="goToGeneralConfigReset1"/>
        <waitForPageLoad stepKey="waitForConfigPageReset1"/>
        <actionGroup ref="AdminSwitchWebsiteActionGroup" stepKey="AdminSwitchStoreViewActionGroup1">
            <argument name="website" value="_defaultWebsite"/>
        </actionGroup>
        <conditionalClick selector="{{LocaleOptionsSection.sectionHeader}}" dependentSelector="{{LocaleOptionsSection.timezone}}" visible="false" stepKey="openLocaleSectionReset1"/>
        <uncheckOption selector="{{LocaleOptionsSection.useDefault}}"  stepKey="uncheckUseDefault1"/>
        <selectOption selector="{{LocaleOptionsSection.timezone}}" userInput="$originalTimezone" stepKey="resetTimezone1"/>
        <click selector="{{AdminMainActionsSection.save}}" stepKey="saveConfigReset1"/>
    </test>
</tests>
