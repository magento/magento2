<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->
<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminCheckCustomAttributeValuesAfterProductSaveTest">
        <annotations>
            <features value="Catalog"/>
            <stories value="Product attributes"/>
            <title value="Saving custom attribute values using UI"/>
            <description value="Checks that saved custom attribute values are reflected on the product's edit page"/>
            <severity value="MAJOR"/>
            <testCaseId value="MC-17516"/>
            <useCaseId value="MC-29022"/>
            <group value="catalog"/>
        </annotations>
        <before>
            <!-- Create multi select product attribute -->
            <createData entity="productAttributeMultiselectTwoOptions" stepKey="createMultiSelectProductAttribute"/>
            <!-- Add options to created product attribute -->
            <createData entity="productAttributeOption1" stepKey="addFirstOptionToAttribute">
                <requiredEntity createDataKey="createMultiSelectProductAttribute"/>
            </createData>
            <createData entity="productAttributeOption2" stepKey="addSecondOptionToAttribute">
                <requiredEntity createDataKey="createMultiSelectProductAttribute"/>
            </createData>
            <createData entity="productAttributeOption3" stepKey="addThirdOptionToAttribute">
                <requiredEntity createDataKey="createMultiSelectProductAttribute"/>
            </createData>
            <!-- Create simple product -->
            <createData entity="SimpleProduct2" stepKey="createSimpleProduct"/>
            <magentoCLI command="indexer:reindex" arguments="catalogsearch_fulltext" stepKey="reindexCatalogSearch"/>
            <!-- Login to Admin page -->
            <actionGroup ref="LoginAsAdmin" stepKey="loginAsAdmin"/>
        </before>
        <after>
            <!-- Delete created entities -->
            <deleteData createDataKey="createSimpleProduct" stepKey="deleteSimpleProduct"/>
            <deleteData createDataKey="createMultiSelectProductAttribute" stepKey="deleteMultiSelectProductAttribute"/>
            <!-- Clear products grid filters -->
            <actionGroup ref="ClearProductsFilterActionGroup" stepKey="clearProductsGridFilters"/>
            <waitForPageLoad stepKey="waitForCleanProductsFilters"/>
            <!-- Logout from Admin page -->
            <actionGroup ref="logout" stepKey="logout"/>
        </after>

        <!-- Open created product for edit -->
        <actionGroup ref="SearchForProductOnBackendActionGroup" stepKey="searchForProductInProductsGrid">
            <argument name="product" value="$createSimpleProduct$"/>
        </actionGroup>
        <actionGroup ref="OpenEditProductOnBackendActionGroup" stepKey="openProductForEdit">
            <argument name="product" value="$createSimpleProduct$"/>
        </actionGroup>

        <!-- Add created attribute to the product -->
        <actionGroup ref="addProductAttributeInProductModal" stepKey="addAttributeToProduct">
            <argument name="attributeCode" value="$createMultiSelectProductAttribute.attribute_code$"/>
        </actionGroup>
        <waitForPageLoad stepKey="waitForAttributeAdded"/>

        <!-- Expand 'Attributes' tab -->
        <actionGroup ref="AdminExpandProductAttributesTabActionGroup" stepKey="expandAttributesTab"/>
        <!-- Check created attribute presents in the 'Attributes' tab -->
        <seeElement selector="{{AdminProductAttributesSection.attributeDropdownByCode($createMultiSelectProductAttribute.attribute_code$)}}" stepKey="assertAttributeIsPresentInTab"/>
        <!-- Select attribute options -->
        <selectOption selector="{{AdminProductAttributesSection.attributeDropdownByCode($createMultiSelectProductAttribute.attribute_code$)}}" parameterArray="[$addFirstOptionToAttribute.option[store_labels][0][label]$, $addThirdOptionToAttribute.option[store_labels][0][label]$]" stepKey="selectAttributeOptions"/>
        <!-- Save product -->
        <actionGroup ref="saveProductForm" stepKey="saveProductForm"/>

        <!-- Check attribute options are selected -->
        <actionGroup ref="AdminExpandProductAttributesTabActionGroup" stepKey="expandAttributesTabAfterProductSave"/>
        <seeOptionIsSelected selector="{{AdminProductAttributesSection.attributeDropdownByCode($createMultiSelectProductAttribute.attribute_code$)}}" userInput="$addFirstOptionToAttribute.option[store_labels][0][label]$" stepKey="assertFirstOptionIsSelected"/>
        <seeOptionIsSelected selector="{{AdminProductAttributesSection.attributeDropdownByCode($createMultiSelectProductAttribute.attribute_code$)}}" userInput="$addThirdOptionToAttribute.option[store_labels][0][label]$" stepKey="assertThirdOptionIsSelected"/>

        <!-- Search for the product on Storefront -->
        <amOnPage url="{{StorefrontHomePage.url}}" stepKey="goToHomePage"/>
        <waitForPageLoad stepKey="waitForHomePageLoad"/>
        <actionGroup ref="StorefrontCheckQuickSearchActionGroup" stepKey="searchProductOnStorefront">
            <argument name="phrase" value="$createSimpleProduct.name$"/>
        </actionGroup>

        <!-- Assert that attribute values present in layered navigation -->
        <actionGroup ref="AssertStorefrontAttributeOptionPresentInLayeredNavigationActionGroup" stepKey="assertFirstAttributeOptionPresence">
            <argument name="attributeLabel" value="$createMultiSelectProductAttribute.attribute[frontend_labels][0][label]$"/>
            <argument name="attributeOptionLabel" value="$addFirstOptionToAttribute.option[store_labels][0][label]$"/>
        </actionGroup>
        <actionGroup ref="AssertStorefrontAttributeOptionPresentInLayeredNavigationActionGroup" stepKey="assertThirdAttributeOptionPresence">
            <argument name="attributeLabel" value="$createMultiSelectProductAttribute.attribute[frontend_labels][0][label]$"/>
            <argument name="attributeOptionLabel" value="$addThirdOptionToAttribute.option[store_labels][0][label]$"/>
        </actionGroup>
    </test>
</tests>
