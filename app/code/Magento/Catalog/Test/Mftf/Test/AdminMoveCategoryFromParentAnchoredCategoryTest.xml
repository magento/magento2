<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->
<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminMoveCategoryFromParentAnchoredCategoryTest">
        <annotations>
            <stories value="Move categories"/>
            <title value="Move default subcategory with anchored parent to default subcategory"/>
            <description value="Login as admin,move subcategory with anchored parent to default subcategory"/>
            <testCaseId value="MC-6492"/>
            <severity value="CRITICAL"/>
            <group value="mtf_migrated"/>
            <features value="Catalog"/>
            <group value="cloud"/>
        </annotations>
        <before>
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginToAdminPanel"/>
            <createData entity="defaultSimpleProduct" stepKey="simpleProduct"/>
            <createData entity="_defaultCategory" stepKey="createDefaultCategory"/>
        </before>
        <after>
            <deleteData  createDataKey="simpleProduct" stepKey="deleteSimpleProduct"/>
            <deleteData createDataKey="createDefaultCategory" stepKey="deleteDefaultCategory"/>
            <actionGroup ref="DeleteCategoryActionGroup" stepKey="deleteCategory">
                <argument name="categoryEntity" value="SimpleSubCategory"/>
            </actionGroup>
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logout"/>
        </after>

        <!--Open Category page-->
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="openAdminCategoryIndexPage"/>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="clickOnExpandTree"/>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="selectCategory"/>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="waitForPageToLoad"/>

        <!--Enable Anchor for _defaultCategory category -->
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="scrollToDisplaySetting"/>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="selectDisplaySetting"/>
        <actionGroup ref="AdminAnchorCategoryActionGroup" stepKey="enableAnchor">
            <argument name="categoryName" value="{{_defaultCategory.name}}"/>
        </actionGroup>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="saveSubCategory"/>

        <!--Create a Subcategory under _defaultCategory category-->
        <actionGroup ref="AdminClickAddSubcategoryButtonActionGroup" stepKey="clickOnAddSubCategoryButton"/>
        <actionGroup ref="AdminChangeCategoryNameActionGroup" stepKey="addSubCategoryName">
            <argument name="categoryName" value="{{SimpleSubCategory.name}}"/>
        </actionGroup>

        <!--Add a product to SimpleSubCategory category-->
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="scrollToProductInCategory"/>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="clickOnProductInCategory"/>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="selectProduct"/>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="clickSearchButton"/>
        <actionGroup ref="AdminAddProductToCategoryActionGroup" stepKey="selectProductFromTableRow">
            <argument name="product" value="$$simpleProduct$$"/>
        </actionGroup>
        <actionGroup ref="AdminSaveCategoryActionGroup" stepKey="saveSubCategory1"/>
        <actionGroup ref="AssertMessageInAdminPanelActionGroup" stepKey="seeSuccessMessage">
            <argument name="message" value="You saved the category."/>
        </actionGroup>

        <comment userInput="Adding the comment to replace CliIndexerReindexActionGroup action group ('indexer:reindex' commands) for preserving Backward Compatibility" stepKey="reindex"/>

        <!--Verify category displayed in store front page-->
        <amOnPage url="/$$createDefaultCategory.custom_attributes[url_key]$$/{{SimpleSubCategory.urlKey}}.html" stepKey="seeTheCategoryInStoreFrontPage"/>
        <waitForPageLoad  stepKey="waitForStoreFrontPageLoad"/>
        <actionGroup ref="StorefrontAssertCategoryNameIsShownInMenuActionGroup" stepKey="seeDefaultCategoryOnStoreNavigationBar">
            <argument name="categoryName" value="{{_defaultCategory.name}}"/>
        </actionGroup>
        <actionGroup ref="StorefrontAssertCategoryNameIsNotShownInMenuActionGroup" stepKey="dontSeeSubCategoryOnStoreNavigationBar">
            <argument name="categoryName" value="{{SimpleSubCategory.name}}"/>
        </actionGroup>

        <!--Check category breadcrumbs in store  front page-->
        <grabMultiple selector="{{StorefrontNavigationSection.categoryBreadcrumbs}}"  stepKey="breadcrumbs"/>
        <assertEquals  stepKey="verifyTheCategoryInStoreFrontPage">
            <expectedResult type="array">['Home', $$createDefaultCategory.name$$,{{SimpleSubCategory.name}}]</expectedResult>
            <actualResult type="variable">breadcrumbs</actualResult>
        </assertEquals>

        <!--Verify Product displayed in category store front page-->
        <click selector="{{StorefrontCategoryMainSection.productLink}}" stepKey="openSearchedProduct"/>
        <waitForPageLoad  stepKey="waitForProductToLoad1"/>
        <actionGroup ref="AssertStorefrontProductInfoMainProductNameActionGroup" stepKey="assertProductName">
            <argument name="value" value="{{defaultSimpleProduct.name}}"/>
        </actionGroup>

        <!--Open Category Page-->
        <actionGroup ref="AdminOpenCategoryPageActionGroup" stepKey="openAdminCategoryIndexPage1"/>
        <actionGroup ref="AdminExpandCategoryTreeActionGroup" stepKey="clickOnExpandTree2"/>

        <!--Move SubCategory under Default Category-->
        <dragAndDrop selector1="{{AdminCategorySidebarTreeSection.categoryInTree(SimpleSubCategory.name)}}" selector2="{{AdminCategorySidebarTreeSection.categoryInTree('Default Category')}}" stepKey="moveCategory"/>
        <see selector="{{AdminCategoryModalSection.message}}" userInput="This operation can take a long time" stepKey="seeWarningMessage"/>
        <click selector="{{AdminCategoryModalSection.ok}}" stepKey="clickOkButtonOnWarningPopup"/>
        <waitForPageLoad stepKey="waitForPageToLoad3"/>
        <see selector="{{AdminCategoryMessagesSection.SuccessMessage}}" userInput="You moved the category." stepKey="seeSuccessMoveMessage"/>

        <!--Open category in store front page-->
        <actionGroup ref="StorefrontGoToCategoryPageActionGroup" stepKey="seeTheCategoryInStoreFrontPage1">
            <argument name="categoryName" value="{{SimpleSubCategory.name}}" />
        </actionGroup>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="waitForStoreFrontPageLoad1"/>

        <!--Verify breadcrumbs after the move in store front page-->
        <grabMultiple selector="{{StorefrontNavigationSection.categoryBreadcrumbs}}"  stepKey="breadcrumbsAfterMove"/>
        <assertEquals  stepKey="verifyBreadcrumbsInFrontPageAfterMove">
            <expectedResult type="array">['Home',{{SimpleSubCategory.name}}]</expectedResult>
            <actualResult type="variable">breadcrumbsAfterMove</actualResult>
        </assertEquals>

       <!--Open category store front page -->
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="amOnCategoryPage"/>
        <comment userInput="Comment is added to preserve the step key for backward compatibility" stepKey="waitForPageToBeLoaded"/>

        <!--Verify Category in store front-->
        <seeElement selector="{{StorefrontCategoryMainSection.CategoryTitle(SimpleSubCategory.name)}}" stepKey="seeCategoryInTitle"/>
        <actionGroup ref="StorefrontAssertCategoryNameIsShownInMenuActionGroup" stepKey="seeSubCategoryOnStoreNavigationBarAfterMove">
            <argument name="categoryName" value="{{SimpleSubCategory.name}}"/>
        </actionGroup>
        <click selector="{{StorefrontCategoryMainSection.productLink}}" stepKey="openSearchedProduct1"/>
        <waitForPageLoad  stepKey="waitForProductToLoad2"/>

        <!--Verify product name on Store Front-->
        <actionGroup ref="AssertStorefrontProductInfoMainProductNameActionGroup" stepKey="assertProductNameAfterMove">
            <argument name="value" value="{{defaultSimpleProduct.name}}"/>
        </actionGroup>
    </test>
</tests>
